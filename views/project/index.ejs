    <!DOCTYPE html>
<html lang="en">
<head>
    <title>Project creation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="css/bootstrap-duallistbox.min.css" rel="stylesheet" type="text/css" media="all">
    <link rel='stylesheet' href='\css\bootstrap.min.css'/>
    <link rel='stylesheet' href='\css\form.css'/>
    <link rel='stylesheet' href='\css\jquery-ui.min.css'/>

</head>
<body>
    
   <!--code for navigation bar-->
     <div class="navbar navbar-default navbar-fixed-top navbar-home" >
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="/home"> Marina Project Management</a>
            <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>  
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right ">
            <li><a href="/about">About</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/contact">Contact Us</a></li>
            <li><a href="/signout">Log Out</a></li>         
          </ul>
        </div>
      </div>
    </div>
     <!--  code for navigation bar ends here-->

    <div class="jumbotron">
      <div class="container" id="header">
        <h3 class="lead"><strong>Create a New Project</strong></h3> 
       </div>
    </div>

      <!--pop up for success message-->
    <div id="success" class="hidden">  
        <span class="success-msg">       
           <h4>Project Created Successfully <span class=" glyphicon glyphicon-ok"></span></h4>   
        </span> 
   </div>


    <div class="container beneficiary">
      <div class="panel panel-default beneficiary_panel" >
        <div class="panel-body">

    
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <form  class="form-horizontal" role="form">
                    <div class="form-group required">
                        <label for="category" class="control-label col-sm-4">Project Category</label>
                        <div class="col-sm-8">
                              <select class="form-control" name="category" id="category" required autofocus>
                                      <option value="">Select a category</option>
                              </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="name" class="control-label col-sm-4">Project Name</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="project" placeholder="Project Name" name="project" required><span class="error" id="projectError"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Desc" class="control-label col-sm-4">Project Description</label>
                        <div class="col-sm-8">
                            <input type="text" id="desc" class="form-control" placeholder="Project Description" name="desc" required >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="lead" class=" control-label col-sm-4">Project Lead</label>
                        <div class="col-sm-8">
                            <input type="text" id="lead"  class="form-control" placeholder="Name of Project Lead" name="lead" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email" class=" control-label col-sm-4">Contact Email</label>
                        <div class="col-sm-8">
                            <input type="email" id="email" class="form-control" placeholder="Contact Email id" name="email" required >
                        </div>
                    </div>

                    <div class="form-group">    
                        <label for="locations" class=" control-label col-sm-4 col-xs-12">Locations</label>
                        <div class="col-xs-12 col-sm-8">
                              <select multiple="multiple" size="10" id="locations"></select> 
                              <span class="error" id="locationsError"></span>
                        </div>
                    </div>


                    <div class="form-group has-feedback">
                        <label for="period" class=" control-label col-sm-4 col-xs-12">Project Timeframe</label>
                        <div class="col-sm-4 col-xs-6">
                            <input type= "text" id="start-date" class=" form-control" placeHolder="Start Date" required>
                            <i class="glyphicon glyphicon-calendar form-control-feedback"></i>
                            <span class="error" id="startDateError"></span>
                        </div>
                        <div class="col-sm-4 col-xs-6">
                            <input type= "text" id="end-date" class="form-control" placeholder="End Date" required>
                            <i class="glyphicon glyphicon-calendar form-control-feedback"></i>
                            <span class="error" id="endDateError"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="funds" class=" control-label col-sm-4 col-xs-12">Project Fund</label>

                        <div class="col-sm-6 col-xs-8">
                             <input type="text" id="funds" class="form-control" placeholder="Project fund" name="funds" required><span class="error" id="fundsError"></span>
                        </div>

                        <div class="col-sm-2 col-xs-4">
                              <input id="funds" class="form-control" value="INR" name="currency" readonly>
                        </div>
                    </div>


                    <div class="form-group">
                        <div class="col-sm-offset-6 col-xs-12 col-xs-offset-3">
                             <button class="btn btn-primary" id="submit" type="submit"> Add Project</button>
                        </div>
                    </div>
                </form>
              </div>
            </div><!--row-->
          </div>
        </div>
      </div><!--container-->

     <!-- Site footer -->
     
     <footer class="footer">
        <div class="container"> 
          <p> PayPal &copy; Powered By Marina</p>
        </div>
     </footer>


    </body>
    <script src="\js\jquery.js"></script> 
    <script src="\js\jquery-ui.js"></script> 
    <script src="\js\bootstrap.min.js"></script>
    <script src="\js\jquery.bootstrap-duallistbox.min.js"></script>

    <script type="text/javascript">
    
     $(document).ready(function(){


        //Date controls
        $('#start-date , #end-date').datepicker().change(function(){
             $('.error').hide();
             isDateValid($(this));
        });



        //Start and end date validations
        function isDateValid(dateObject){
             var start_date=new Date($('#start-date').val()).getTime();
             var end_date=new Date($('#end-date').val()).getTime();


            if( dateObject.attr('id')=="end-date" && isNaN(start_date)){
                $("#startDateError").html("Please give the start date too").show();
             }

             if(start_date>end_date){
                $("#endDateError").html("End date falls before start date").show();
            }
        }

       //For populating project category dropdown
        $.ajax({
            url:"../projectCategory",
            type:"GET",
            headers:{"Accept":"application/json;odata=verbose"},
            success:function(data){
                for(var i in data){
                    var item=$('<option>'+data[i].name+'</option>');
                    $('#category').append(item);
                }
            },
            error:function(data){
                alert("error");
            }
        });

        //For populating locations list
            $.ajax({
                  url:"../AllLocations",
                  type:"GET",
                  headers:{"Accept":"application/json;odata=verbose"},
                  success:function(data){
                           for(var i in data){
                                  var item=$('<option>'+data[i].location+'</option>');
                                  $('#locations').append(item);
                          }
                    },
                  error:function(data){
                       alert("error");
                   },
                  async:false
             });

        //For handling location list events
             $('#locations').bootstrapDualListbox({
                  bootstrap2compatible    : false,
                  preserveselectiononmove : false,            // 'all' / 'moved' / false
                  moveonselect            : true,             // true/false (forced true on androids, see the comment later)
                  initialfilterfrom       : '',               // string, filter selectables list on init
                  initialfilterto         : '',               // string, filter selected list on init
                  helperselectnamepostfix     : '_helper',    // 'string_of_postfix' / false
                  infotext: 'Showing all {0}',// text when all options are visible / false for no info text
                  infotextfiltered        : '<span class="label label-warning">Filtered</span> {0} from {1}',// when not all of the options are visible due to the filter
                  selectorminimalheight   : 100,
                  showfilterinputs        : true,
                  filterplaceholder       : 'Filter',
                  filtertextclear         : 'show all',
                  nonselectedlistlabel    : false,            // 'string', false
                  selectedlistlabel       : false,            // 'string', false
                  filteronvalues          : false             // filter by selector's values, boolean
         });



        //Validating funds field to accept numbers & decimal alone
         $("#funds").on('keydown', function (e) {

            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57) && (e.which < 96 || e.which > 105) && e.which!=188 && e.which!=190 && e.which!=110 && e.which!=9  ) {
                  //display error message
                  $("#fundsError").html("Please enter valid amount").show().fadeOut(2000);
                  return false;
            }
        });


         //Check if entered project exists in this category already
         $('#project').focusout(function(){

               var category=$('option:selected', '#category').val();
               var project=$(this).val();

               $.ajax({
                url:"../projects",
                type:"GET",
                data:'category='+category,
                headers:{"Accept":"application/json;odata=verbose"},
                success:function(data){

                    //Loop through projects json
                    $(data).each(function(index,element){

                            //Display error
                            if(project==element){
                                  $("#projectError").html("  Project already exists in selected category").show();
                                  return false;
                            }

                            //Remove error
                            $("#projectError").html("");  
                    });

                    
                },
                error:function(data){
                    alert("error");
                }
              });
               

         });


           //For submitting data
           $('#submit').on('click',function(e){
                               
                      var selectedLoc=[];
                      var isFormEmpty="false";

                      //Getting selected locations
                      $('#bootstrap-duallistbox-selected-list_ option').each(function(i,selected){
                          selectedLoc[i] = $(selected).text();
                      });

                

                      var locations=[];

                      //Forming JSON Array for locations
                      for(var i=0;i<selectedLoc.length;i++){
                          locations.push(selectedLoc[i]);
                      }
 
 
                      //Forming JSON object for form data to be sent to handle POST
                      var formData=new Object;
                      
                      formData.category=$('option:selected', '#category').val();
                      formData.name=$("#project").val();
                      formData.desc=$("#desc").val();
                      formData.lead=$("#lead").val();
                      formData.email=$("#email").val();
                      formData.start_date=$("#start-date").val();
                      formData.end_date=$("#end-date").val();
                      formData.funds=$("#funds").val();
                      formData.currency=$("#currency").val();
                      formData.updated_at=new Date();
                      
                      
                      //Check for empty fields
                      if(formData["category"]=="" || formData["name"]=="" ||formData["desc"]=="" ||formData["lead"]==""||formData["email"]==""||formData["start_date"]==""||formData["end_date"]==""||formData["funds"]==""||formData["currency"]||formData["updated_at"]==""){
                             var isFormEmpty=true;
                      }
                      
                      if(selectedLoc.length==0 && isFormEmpty=="false"){
                            $("#locationsError").html("  Please select locations").show();
                            return false;
                      }else{
                            $("#locationsError").html(""); 
                             formData.locations=locations;

                      }

                      if(isFormEmpty=="false"){
                           $.ajax({
                                  url:"../project/create",
                                  type:"POST",
                                  data:{
                                      details:formData
                                      },
                                  dataType:"json",
                                  success:function(){
                                         $('#success').removeClass('hidden');
                                         window.setTimeout(function(){location.reload()},20000)
                                   },
                                  error:function(){
                                  
                                   },
                                  async:false
                              });
                    } 
              


                   });
                });

    </script>


 
</html>
